---
title: "Groundwater information for {{{ site }}}"
date: "`r Sys.Date()`"
output: 
  {{{ output_type }}}_document
---


```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE,
               warning = FALSE,
               message = FALSE,
               fig.width = 7,
               fig.height = 6)
library(dplyr)
library(tidyr)
library(ggplot2)
library(HASP)

options(knitr.kable.NA = '')
```


## Site Information

```{r siteInfo, results='asis'}
library(HASP)

siteID <- "{{{ site }}}"
type <- "{{{ output_type }}}"

site_metadata <- site_summary(siteID, markdown = type == "html")

pcodes <- dataRetrieval::whatNWISdata(siteNumber = siteID,
                                      service = c("gw", "dv")) 
  
```



```{r whatData}
data_info <- data_available(siteID)
kable(data_info)
```


```{r getData}
library(dataRetrieval)

# Figure out what data to retrieve
available_pcodes <- unique(pcodes$parm_cd[pcodes$data_type_cd == "dv"])
available_statCds <- unique(pcodes$stat_cd[pcodes$data_type_cd == "dv"])

# Use the parameter with the highest count
# This can be changed and then r
parameterCd <- unique(pcodes$parm_cd[which(pcodes$count_nu ==
                                      max(pcodes$count_nu,na.rm = TRUE) & 
                                      pcodes$data_type_cd == "dv")])

statCd <- pcodes$stat_cd[which(pcodes$count_nu ==
                                      max(pcodes$count_nu,na.rm = TRUE) & 
                                      pcodes$data_type_cd == "dv")][1]

pCode_info <- dataRetrieval::readNWISpCode(parameterCd)
yaxis <- pCode_info$parameter_nm

flip <- parameterCd == "72019"

# Daily data:
if(any(pcodes$data_type_cd == "dv")){
  gw_level_dv <- dataRetrieval::readNWISdv(siteID,
                            available_pcodes,
                            statCd = available_statCds)
}
# Field GWL measured:
if(any(pcodes$data_type_cd == "gw")){
  gwl_data <- dataRetrieval::readNWISgwl(siteID)
}
```

## Water Level Data and Analysis

### Monthly frequency

```{r monthlyFreq}
monthly_frequency_plot(gw_level_dv,
                       parameter_cd = parameterCd,
                       stat_cd = statCd, 
                       plot_title = siteID, 
                       flip_y = flip,
                       y_axis_label = yaxis)

```



```{r}
month_table <- monthly_frequency_table(gw_level_dv,
                       parameter_cd = parameterCd,
                       stat_cd = statCd)

knitr::kable(month_table, digits = 1) %>%
    kableExtra::kable_styling()%>%
    kableExtra::row_spec(as.integer(strftime(Sys.Date(), format = "%m")),
                         bold = TRUE,
                         hline_after = TRUE)

```


### Weekly frequency

```{r weeklyFrequency}

weekly_frequency_plot(gw_level_dv, 
                      parameter_cd = parameterCd, 
                      stat_cd = statCd,
                      plot_title = siteID,
                      flip_y = flip,
                      y_axis_label = yaxis)


```



Weekly frequency analysis of daily maximum water level record. Only showing the first 10 rows for this example:

```{r weekly_table}
weekly_table <- weekly_frequency_table(gw_level_dv, 
                                       parameter_cd = parameterCd, 
                                       stat_cd = statCd) 

todays_week <- as.integer(strftime(Sys.Date(), format = "%V"))

  
knitr::kable(weekly_table[(todays_week-4):(todays_week+5),], digits = 1) %>%
    kableExtra::kable_styling()%>%
    kableExtra::row_spec(5,
                         bold = TRUE,
                         hline_after = TRUE)



```


### Daily 2-year

```{r dailyPlotShow, fig.width=9}
daily_gwl_2yr_plot(gw_level_dv, 
                   parameter_cd = parameterCd,
                   plot_title = siteID,
                   stat_cd = statCd,
                   flip_y = flip,
                   historical_stat = "mean",
                   month_breaks = TRUE,
                   y_axis_label = yaxis)

```


Statistics of maximum daily water level record (DOY = day of year). Only showing the first 10 rows for this example:

```{r dailyShow2}
daily_table <- daily_frequency_table(gw_level_dv, 
                                     parameter_cd = parameterCd,
                                     stat_cd = statCd) 

todays_day <- as.POSIXlt(Sys.Date())$yday

knitr::kable(daily_table[(todays_day-4):(todays_day + 5),]) %>%
    kableExtra::kable_styling()%>%
    kableExtra::row_spec(5,
                         bold = TRUE,
                         hline_after = TRUE)
```


### Daily value trends


```{r gwlTrendplot}

gwl_plot_all(gw_level_dv, gwl_data, 
             y_label = yaxis,
             parameter_cd = parameterCd, 
             stat_cd = statCd,
             flip_y = flip,
             plot_title = siteID,
             add_trend = TRUE)


```

Summary statistics for maximum daily water level measurements:

```{r siteStatsDaily}
gw <- gw_level_dv
names(gw)[names(gw) == paste("X",
                             parameterCd,
                             statCd, sep = "_")] <- "value"
siteDV <- site_data_summary(gw) 

site_out <- knitr::kable(t(siteDV), digits = 1)

if(type == "html"){
  site_out <- site_out %>%
  kableExtra::kable_styling(full_width = FALSE)
}

site_out
```

Results of trend analysis on maximum daily water levels:

```{r trendTableDaily}
gw_monthly <- monthly_mean(gw_level_dv, 
                           value_col = paste("X", parameterCd, statCd, sep = "_"))

trend_result <- kendell_test_5_20_years(gw_monthly, 
                        seasonal = TRUE, 
                        date_col = "mid_date", 
                        value_col = "mean_va")
kable(trend_result, digits = 1)


```



### Field GWL values



```{r manualPlot}
gwl_plot_all(NULL, gwl_data,
             y_label = yaxis,
             flip_y = flip,
             parameter_cd = parameterCd,
             plot_title = siteID)

```



Summary statistics for manual water level measurements

```{r manualTable}

quantiles <- gwl_data %>% 
  rename(value = sl_lev_va) %>% 
  site_data_summary() 

q_out <- knitr::kable(t(quantiles), digits = 1)

if(type == "html"){
  q_out <- q_out %>%
  kableExtra::kable_styling(full_width = FALSE)
}

q_out

```


